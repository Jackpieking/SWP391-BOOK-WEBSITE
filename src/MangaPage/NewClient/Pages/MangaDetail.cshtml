@page "/truyen-tranh/{ComicIdentifier:guid}"
@model NewClient.Pages.MangaDetailModel
@using Microsoft.AspNetCore.DataProtection;
@using Microsoft.AspNetCore.Http;
@using NewClient.Services;
@inject IHttpContextAccessor _httpContextAccessor
@inject IDataProtectionProvider _dataProtectionProvider
@inject UserService _userService
@inject JWTService _JWTService
@{
    ViewData["Title"] = $"{Model.DisplayComicInformationModel.ComicName} [Tới Chapter {Model.DisplayComicInformationModel.ComicChapters.First().ChapterNumber}] Tiếng Việt | Manganexus.Com";
}

<!-- Breadcrumb Begin -->
<div class="breadcrumb-option">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__links">
                    <a asp-page="Index"><i class="fa fa-home"></i> Trang chủ</a>
                    <a asp-page="MangaDetail" asp-route-ComicIdentifier="@Request.RouteValues["ComicIdentifier"].ToString()"> @Model.DisplayComicInformationModel.ComicName</a>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Breadcrumb End -->
<!-- Anime Section Begin -->
<section class="anime-details spad">
    <div class="container">
        <div class="anime__details__content">
            <div class="row">
                <div class="col-lg-3">
                    <div class="anime__details__pic set-bg" data-setbg="@Model.DisplayComicInformationModel.ComicAvatar">
                        <div class="comment"><i class="fa fa-comments"></i> @Model.DisplayComicInformationModel.ReviewComics.Count</div>
                        <div class="view"><i class="fa fa-eye"></i> @Model.DisplayComicInformationModel.ReaderCounts</div>
                    </div>
                </div>
                <div class="col-lg-9">
                    <div class="anime__details__text">
						<div class="row">
                            <div class="anime__details__title col-lg-9">
                                <h3>@Model.DisplayComicInformationModel.ComicName</h3>
                            </div>
                            <div class="anime__details__rating col-lg-3">
                                @{
                                    var totalStars = default(decimal);
                                    var averageStars = default(decimal);
                                    var reviewComicDtoCount = Model.DisplayComicInformationModel.ReviewComics.Count;

                                    if (reviewComicDtoCount == 0)
                                    {
                                        averageStars = 0;
                                    }
                                    else
                                    {
                                        foreach (var reviewComic in Model.DisplayComicInformationModel.ReviewComics)
                                        {
                                            totalStars += reviewComic.ComicRatingStar;
                                        }

                                        averageStars = totalStars / reviewComicDtoCount;
                                    }
                                }
                                <div class="rating">
                                    @for (int displayStar = 1; displayStar <= averageStars; displayStar++)
                                    {
                                        <i class="fa fa-star"></i>
                                    }

                                    @for (int displayStar = 0; displayStar < averageStars - Math.Floor(d: averageStars); displayStar++)
                                    {
                                        <i class="fa fa-star-half-o"></i>
                                    }
                                </div>
                                <span>@reviewComicDtoCount Bình chọn</span>
                            </div>
                        </div>
                        <p>@Model.DisplayComicInformationModel.ComicDescription</p>
                        <div class="anime__details__widget">
                            <div class="row">
                                <div class="col-lg-12 col-md-12">
                                    <ul>
                                        <li><span>Người đăng:</span> @Model.DisplayComicInformationModel.PublisherName</li>
                                        <li><span>Ngày đăng:</span> @Model.DisplayComicInformationModel.ComicPublishedDate</li>
                                        <li><span>Chương mới nhất:</span> @Model.DisplayComicInformationModel.ComicChapters.First().ChapterNumber</li>
                                        <li>
                                            <span>Thể loại: </span>
                                            @string.Join(", ", Model.DisplayComicInformationModel.CategoryNames)
                                        </li>
                                        <li><span>Số người đã đọc:</span> @Model.DisplayComicInformationModel.ReaderCounts</li>
                                        <li><span>Số bình luận:</span> @reviewComicDtoCount</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="anime__details__btn">
                            <a
                                asp-page="ComicReading"
                                asp-route-ChapterIdentifier="@Model.DisplayComicInformationModel.ComicChapters.Last().ChapterIdentifier"
                                asp-route-ComicIdentifier="@Request.RouteValues["comicIdentifier"].ToString()"
                                class="watch-btn">
                                <span>Đọc ngay
                                    <i class="fa fa-angle-right"></i>
                                </span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mb-5">
            <div class="section-title mb-4">
                <h5>Danh sách chương</h5>
            </div>
            <div class="col-lg-12 col-md-12">
                @{
                    var chapterCount = Model.DisplayComicInformationModel.ComicChapters.Count;

                    var chapterBoxHeight = chapterCount >= 10
                        ? 10 * 55
                        : chapterCount * 55;
                }
                <div class="card bg-dark border-white" style="height:@(chapterBoxHeight)px;overflow-y:scroll">
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            @foreach (var chapter in Model.DisplayComicInformationModel.ComicChapters)
                            {
                                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-end bg-dark p-1">
                                    <div>
                                        <a asp-page="ComicReading"
                                           asp-route-ChapterIdentifier="@chapter.ChapterIdentifier"
                                           asp-route-ComicIdentifier="@Request.RouteValues["comicIdentifier"].ToString()"
                                           class="text-bg-dark">
                                           Chapter @chapter.ChapterNumber</a>
                                    </div>
                                    <div class="d-flex">
                                        <div>
                                            <p class="text-bg-dark mb-0">@chapter.AddedDate</p>
                                        </div>
                                        <div>
                                            <p class="mb-0 ms-4 badge rounded-pill text-bg-primary">@chapter.ChapterUnlockPrice Coins</p>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-8 col-md-8">
                <div class="anime__details__review">
                    <div class="section-title mb-4">
                        <h5>Đánh giá</h5>
                    </div>
                    @if (Model.DisplayComicInformationModel.ReviewComics.Count == 0)
                    {
                        <div class="alert alert-danger fs-3" role="alert">
                            Chưa có bình luận
                        </div>
                    }
                    else
                    {
                        @foreach (var reviewItem in Model.DisplayComicInformationModel.ReviewComics)
                        {
                            <div class="anime__review__item">
                                <div class="anime__review__item__pic">
                                    <img src="/image/user/User_Empty.png" alt="">
                                </div>
                                <div class="anime__review__item__text">
                                    <div class="rating">
                                        @for (int star = 0; star < reviewItem.ComicRatingStar; star++)
                                        {
                                            <i class="fa fa-star"></i>
                                        }
                                    </div>
                                    <h6 class="mt-3">@reviewItem.Username - <span>@reviewItem.ReviewTime</span></h6>
                                    <p>@reviewItem.ComicComment</p>
                                </div>
                            </div>
                        }
                    }
                </div>
                <div class="anime__details__form">
                    @{
                        var authToken = _httpContextAccessor
                        .HttpContext
                        .Request
                        .Cookies
                        .FirstOrDefault(cookie => cookie.Key.StartsWith("authCookie"))
                        .Value;

                        if (Equals(authToken, null))
                        {
                            var token = TempData["token"];
                            TempData.Keep("token");

                            if (!Equals(token, null))
                            {
                                authToken = _httpContextAccessor
                                .HttpContext
                                .Session
                                .GetString(token.ToString());
                            }
                            else
                            {
                                authToken = string.Empty;
                            }
                        }

                        if (!string.IsNullOrEmpty(authToken))
                        {
                            <form method="post" class="form-floating" asp-page-handler="SubmitComment">
                                <div class="section-title form">
                                    <h5>Đánh giá của bạn</h5>
                                </div>
                                <textarea name="reviewComic" placeholder="Đánh giá vào đây"></textarea>
                                <button type="submit" class="review__submit-button"><i class="fa fa-location-arrow"></i> Đánh giá</button>
                            </form>
                        }
                        else
                        {
                            <div class="alert alert-danger fs-3" role="alert">
                                Đăng nhập để bình luận
                            </div>
                        }
                    }
                </div>
            </div>
            <div class="col-lg-4 col-md-4">
                <div class="anime__details__sidebar">
                    <div class="section-title mb-4">
                        <h5>Bạn có thể thích...</h5>
                    </div>
                    @{
                        byte counter = 4;

                        foreach (var comic in Model.HotComicModels)
                        {
                            <div class="position-relative">
                                <div class="blur"></div>
                                <div class="product__sidebar__view__item set-bg" data-setbg="@comic.ComicAvatar">
                                    <div class="ep">@comic.ComicLatestChapter</div>
                                    <div class="view"><i class="fa fa-eye"></i> @comic.ReadersCounts</div>
                                    <h5>
                                        <a asp-page="MangaDetail" asp-route-ComicIdentifier="@comic.ComicIdentifier">@comic.ComicName</a>
                                    </h5>
                                </div>
                            </div>

                            if (counter == 1)
                            {
                                break;
                            }

                            counter--;
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Anime Section End -->
