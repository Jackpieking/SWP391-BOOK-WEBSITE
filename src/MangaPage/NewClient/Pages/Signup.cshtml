@page "/auth/register"
@model NewClient.Pages.SignupModel
@{
    ViewData["Title"] = "Đăng ký";
}

@section ValidateScript {
    @await Html.PartialAsync("Shared/_ValidationScriptsPartial")
}

<!-- Normal Breadcrumb Begin -->
<section class="normal-breadcrumb set-bg" data-setbg="/image/normal-breadcrumb.jpg">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 text-center">
                <div class="normal__breadcrumb__text">
                    <h2>Đăng Ký</h2>
                    <p>Chào mừng đến với Manganexus</p>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Normal Breadcrumb End -->
<!-- Signup Section Begin -->
<section class="signup spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-6">
                <div class="login__form">
                    <h3>Đăng ký</h3>
                    <div data-bs-theme="dark">
                        <form id="createUserForm" method="dialog">
                            <div class="mb-3">
                                <label asp-for="UserCreationModel.Username" class="form-label text-white">Tài khoản</label>
                                <input asp-for="UserCreationModel.Username" class="form-control" aria-describedby="UsernameHelp">
                                <div id="UsernameHelp" class="form-text">Nhập tài khoản của bạn</div>
                                <span asp-validation-for="UserCreationModel.Username" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="UserCreationModel.UserEmail" class="form-label text-white">Email</label>
                                <input asp-for="UserCreationModel.UserEmail" class="form-control" aria-describedby="EmailHelp">
                                <div id="EmailHelp" class="form-text">Nhập email của bạn</div>
                                <span asp-validation-for="UserCreationModel.UserEmail" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="UserCreationModel.Password" class="form-label text-white">Mật khẩu</label>
                                <input asp-for="UserCreationModel.Password" class="form-control" aria-describedby="PasswordHelp">
                                <div id="PasswordHelp" class="form-text">Nhập mật khẩu của bạn</div>
                                <span asp-validation-for="UserCreationModel.Password" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="UserCreationModel.ConfirmPassword" class="form-label text-white">Xác nhận mật khẩu</label>
                                <input asp-for="UserCreationModel.ConfirmPassword" class="form-control" aria-describedby="ConfirmPasswordHelp">
                                <div id="ConfirmPasswordHelp" class="form-text">Nhập lại mật khẩu của bạn</div>
                                <span asp-validation-for="UserCreationModel.ConfirmPassword" class="text-danger"></span>
                            </div>
                            <button class="btn btn-outline-warning rounded showPasswordBtn" type="button">Hiện mật khẩu</button>
                            <br />
                            <br />
                            <button type="button" class="btn btn-primary btn-lg rounded w-100 createUserBtn">Đăng ký</button>
                            <button type="submit" class="hiddenBtn d-none"></button>
                        </form>
                    </div>
                    <h5>Đã có tài khoản? <a asp-page="Login">Đăng nhập</a></h5>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="login__social__links">
                    <h3>Đăng Nhập Bằng</h3>
                    <ul>
                        <li>
                            <a href="#" class="btn btn-lg btn-primary w-75">
                                <i class="fa fa-facebook"></i> Facebook
                            </a>
                        </li>
                        <li>
                            <a href="#" class="btn btn-lg btn-danger w-75">
                                <i class="fa fa-google"></i> Google
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <button type="button" class="d-none popupFormBtn" data-bs-toggle="modal" data-bs-target="#emailIsExistModel"></button>

</section>

<!-- Modal -->
<div class="modal fade" id="emailIsExistModel" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel text-uppercase text-danger">Thông báo</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-primary">Email đã tồn tại !!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Signup Section End -->
<script defer>
    document
        .querySelector(".showPasswordBtn")
        .addEventListener("click", function (e) {
            let passwordInput = document.querySelector("#UserCreationModel_Password");
            let confirmPasswordInput = document.querySelector("#UserCreationModel_ConfirmPassword");

            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                confirmPasswordInput.type = "text";
            }
            else {
                passwordInput.type = "password";
                confirmPasswordInput.type = "password";
            }
        });

    document
        .querySelector('.createUserBtn')
        .addEventListener("click", function (e) {
            $(".hiddenBtn").click();

            let classCheck = document.getElementsByClassName('field-validation-error').length > 0;

            if (!classCheck) {
                let email = document.querySelector('[name="UserCreationModel.UserEmail"]').value;

                fetch('https://localhost:7174/api/auth/validate-email', {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(email)
                })
                .then(function(data) {
                    if (data.status == 400) {
                        $(".popupFormBtn").click();
                    }
                    else {
                        let createUserForm = document.querySelector("#createUserForm");

                        createUserForm.removeAttribute("method");
                        createUserForm.setAttribute("method", "post");

                        $(".hiddenBtn").click();
                    }
                })
                .catch(function(error) {
                    alert('Request failed');
                });
            }
        });
</script>

